#!/usr/bin/env bash
# ═══════════════════════════════════════════════════════
# Tmux AI Workspace Interactive Launcher
# Created for Frank Yang - VibeGhostty Project
# ═══════════════════════════════════════════════════════

set -e

# ───────────────────────────────────────────────────────
# Colors for beautiful output
# ───────────────────────────────────────────────────────

BLUE="\033[34m"
CYAN="\033[36m"
GREEN="\033[32m"
YELLOW="\033[33m"
MAGENTA="\033[35m"
RED="\033[31m"
BOLD="\033[1m"
RESET="\033[0m"

# ───────────────────────────────────────────────────────
# Configuration
# ───────────────────────────────────────────────────────

LAYOUTS_DIR="$HOME/.tmux-layouts"
PROJECT_DIR="${1:-$PWD}"

# 如果有安裝 fzf，可以用來選擇專案
HAS_FZF=false
if command -v fzf &> /dev/null; then
    HAS_FZF=true
fi

# ───────────────────────────────────────────────────────
# Helper Functions
# ───────────────────────────────────────────────────────

print_header() {
    clear
    echo -e "${BLUE}${BOLD}"
    echo "╔═══════════════════════════════════════════════════════════╗"
    echo "║                                                           ║"
    echo "║          🚀 Tmux AI Workspace Launcher 🤖                ║"
    echo "║                                                           ║"
    echo "║              Created for Frank Yang                       ║"
    echo "║                                                           ║"
    echo "╚═══════════════════════════════════════════════════════════╝"
    echo -e "${RESET}"
    echo ""
}

print_menu() {
    echo -e "${CYAN}${BOLD}Select a workspace layout:${RESET}"
    echo ""
    echo -e "  ${GREEN}1${RESET} │ ${BOLD}AI Workspace${RESET} (primary layout)"
    echo -e "    │ ├─ Codex CLI (70%) + Claude Code (30%)"
    echo -e "    │ └─ Monitor pane for tests/logs"
    echo ""
    echo -e "  ${GREEN}2${RESET} │ ${BOLD}AI Compare${RESET} (side-by-side)"
    echo -e "    │ ├─ Codex vs Claude (50/50 split)"
    echo -e "    │ └─ Compare two AI outputs"
    echo ""
    echo -e "  ${GREEN}3${RESET} │ ${BOLD}Full Focus${RESET} (distraction-free)"
    echo -e "    │ ├─ Single AI fullscreen (100%)"
    echo -e "    │ └─ Ideal for deep work"
    echo ""
    echo -e "  ${GREEN}4${RESET} │ ${BOLD}Resume${RESET} (attach to existing)"
    echo -e "    │ └─ List and attach to running sessions"
    echo ""

    if [[ "$HAS_FZF" == true ]]; then
        echo -e "  ${GREEN}5${RESET} │ ${BOLD}Project selector${RESET}"
        echo -e "    │ └─ Use fzf to choose a project directory"
        echo ""
    fi

    echo -e "  ${RED}q${RESET} │ ${BOLD}Exit${RESET}"
    echo ""
    echo -e "${YELLOW}───────────────────────────────────────────────────────${RESET}"
    echo -e "📁 Current project: ${MAGENTA}$PROJECT_DIR${RESET}"
    echo -e "${YELLOW}───────────────────────────────────────────────────────${RESET}"
    echo ""
}

list_sessions() {
    echo -e "${CYAN}${BOLD}Existing tmux sessions:${RESET}"
    echo ""

    if tmux list-sessions 2>/dev/null; then
        echo ""
        echo -e "${YELLOW}Enter a session name to attach, or press Enter to go back${RESET}"
        read -p "> " session_name

        if [[ -n "$session_name" ]]; then
            if tmux has-session -t "$session_name" 2>/dev/null; then
                echo "🔗 Attaching to $session_name..."
                tmux attach-session -t "$session_name"
                exit 0
            else
                echo -e "${RED}❌ Session '$session_name' not found${RESET}"
                sleep 2
            fi
        fi
    else
        echo -e "${YELLOW}⚠️  No active sessions${RESET}"
        sleep 2
    fi
}

select_project_with_fzf() {
    echo -e "${CYAN}${BOLD}Select a project directory...${RESET}"
    echo ""

    # 搜尋常見的專案目錄
    SEARCH_DIRS=(
        "$HOME/Documents/GitHub"
        "$HOME/Projects"
        "$HOME/Developer"
        "$HOME/Code"
        "$HOME/Work"
    )

    PROJECTS=()
    for dir in "${SEARCH_DIRS[@]}"; do
        if [[ -d "$dir" ]]; then
            while IFS= read -r project; do
                PROJECTS+=("$project")
            done < <(find "$dir" -maxdepth 2 -type d -name ".git" -exec dirname {} \; 2>/dev/null)
        fi
    done

    if [[ ${#PROJECTS[@]} -eq 0 ]]; then
        echo -e "${YELLOW}⚠️  No git projects detected${RESET}"
        sleep 2
        return
    fi

    # 使用 fzf 選擇
    SELECTED=$(printf '%s\n' "${PROJECTS[@]}" | fzf --height=50% --border --prompt="Select project > " --preview="ls -la {}" --preview-window=right:50%)

    if [[ -n "$SELECTED" ]]; then
        PROJECT_DIR="$SELECTED"
        echo -e "${GREEN}✅ Selected: $PROJECT_DIR${RESET}"
        sleep 1
    fi
}

launch_layout() {
    local layout=$1
    local script="$LAYOUTS_DIR/${layout}.sh"

    if [[ ! -f "$script" ]]; then
        echo -e "${RED}❌ Error: layout script '$script' not found${RESET}"
        echo -e "${YELLOW}💡 Make sure you've run the installer${RESET}"
        sleep 3
        return 1
    fi

    echo -e "${GREEN}🚀 Launching $layout...${RESET}"
    sleep 0.5

    bash "$script" "$PROJECT_DIR"
}

# ───────────────────────────────────────────────────────
# Main Loop
# ───────────────────────────────────────────────────────

while true; do
    print_header
    print_menu

    read -p "Choose [1-4/q]: " choice

    case $choice in
        1)
            launch_layout "ai-workspace"
            exit 0
            ;;
        2)
            launch_layout "ai-compare"
            exit 0
            ;;
        3)
            echo ""
            echo -e "${CYAN}Pick the focus tool:${RESET}"
            echo "  1) Codex CLI (default)"
            echo "  2) Claude Code"
            read -p "Choose [1/2]: " ai_choice

            case $ai_choice in
                2)
                    bash "$LAYOUTS_DIR/full-focus.sh" "$PROJECT_DIR" "claude"
                    ;;
                *)
                    bash "$LAYOUTS_DIR/full-focus.sh" "$PROJECT_DIR" "codex"
                    ;;
            esac
            exit 0
            ;;
        4)
            list_sessions
            ;;
        5)
            if [[ "$HAS_FZF" == true ]]; then
                select_project_with_fzf
            else
                echo -e "${RED}❌ Invalid option${RESET}"
                sleep 1
            fi
            ;;
        q|Q)
            echo ""
            echo -e "${YELLOW}👋 Goodbye!${RESET}"
            exit 0
            ;;
        *)
            echo -e "${RED}❌ Invalid choice, try again${RESET}"
            sleep 1
            ;;
    esac
done
