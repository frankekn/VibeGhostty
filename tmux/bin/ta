#!/usr/bin/env bash
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Tmux Attach - æ™ºèƒ½ Tmux Session Wrapper
# Created for Frank Yang - VibeGhostty Project
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# å¿«é€Ÿ attach åˆ°ç•¶å‰å°ˆæ¡ˆçš„ tmux session
# åªéœ€è¼¸å…¥ 2 å€‹å­—å…ƒå³å¯ï¼
#
# Usage:
#   ta              è‡ªå‹•åµæ¸¬ç•¶å‰å°ˆæ¡ˆ
#   ta -l           åˆ—å‡ºæ‰€æœ‰ session
#   ta -n NAME      attach åˆ°æŒ‡å®š session
#   ta -h           é¡¯ç¤ºå¹«åŠ©
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

set -e

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Colors
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

BOLD="\033[1m"
BLUE="\033[38;5;111m"
CYAN="\033[36m"
GREEN="\033[32m"
YELLOW="\033[33m"
RED="\033[31m"
ORANGE="\033[38;5;215m"
RESET="\033[0m"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Helper Functions
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

print_success() {
    echo -e "${GREEN}âœ… $1${RESET}"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${RESET}"
}

print_error() {
    echo -e "${RED}âŒ $1${RESET}"
}

print_info() {
    echo -e "${CYAN}â„¹ï¸  $1${RESET}"
}

print_rocket() {
    echo -e "${BLUE}ğŸš€ $1${RESET}"
}

show_help() {
    cat << 'EOF'
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              ta - æ™ºèƒ½ Tmux Session ç®¡ç†å·¥å…·               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

EOF
    echo -e "${BOLD}${BLUE}ç”¨æ³•ï¼š${RESET}"
    echo ""
    echo "  ta              è‡ªå‹•åµæ¸¬ç•¶å‰å°ˆæ¡ˆä¸¦ attach"
    echo "  ta -l           åˆ—å‡ºæ‰€æœ‰ tmux session"
    echo "  ta --list       åŒä¸Š"
    echo "  ta -n NAME      attach åˆ°æŒ‡å®šåç¨±çš„ session"
    echo "  ta --name NAME  åŒä¸Š"
    echo "  ta -h           é¡¯ç¤ºæ­¤å¹«åŠ©"
    echo "  ta --help       åŒä¸Š"
    echo ""
    echo -e "${BOLD}${ORANGE}åŠŸèƒ½ç‰¹è‰²ï¼š${RESET}"
    echo ""
    echo "  ğŸ¯ è‡ªå‹•åµæ¸¬"
    echo "     â€¢ Git repo â†’ session åç¨± = ai-{repo_name}"
    echo "     â€¢ é git â†’ session åç¨± = ai-{directory_name}"
    echo ""
    echo "  ğŸ” æ™ºèƒ½æª¢æŸ¥"
    echo "     â€¢ Session å­˜åœ¨ â†’ ç›´æ¥ attach"
    echo "     â€¢ Session ä¸å­˜åœ¨ â†’ è©¢å•æ˜¯å¦å»ºç«‹"
    echo ""
    echo "  ğŸ”„ Tmux å…§éƒ¨æ”¯æ´"
    echo "     â€¢ å·²åœ¨ tmux å…§ â†’ ä½¿ç”¨ switch-client"
    echo "     â€¢ ä¸åœ¨ tmux å…§ â†’ ä½¿ç”¨ attach-session"
    echo ""
    echo -e "${BOLD}${GREEN}ä½¿ç”¨ç¯„ä¾‹ï¼š${RESET}"
    echo ""
    echo "  # åœ¨å°ˆæ¡ˆç›®éŒ„å¿«é€Ÿ attach"
    echo "  $ cd ~/projects/VibeGhostty"
    echo "  $ ta"
    echo ""
    echo "  # åˆ—å‡ºæ‰€æœ‰ session"
    echo "  $ ta -l"
    echo ""
    echo "  # æŒ‡å®š session åç¨±"
    echo "  $ ta -n ai-myproject"
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
}

list_sessions() {
    if ! tmux list-sessions &>/dev/null; then
        print_warning "ç›®å‰æ²’æœ‰ä»»ä½• tmux session"
        echo ""
        echo "å»ºè­°åŸ·è¡Œä»¥ä¸‹å‘½ä»¤å»ºç«‹ AI Workspaceï¼š"
        echo -e "  ${ORANGE}tmux-launch${RESET}  ï¼ˆäº’å‹•å¼é¸å–®ï¼‰"
        echo -e "  ${ORANGE}~/.tmux-layouts/ai-workspace.sh${RESET}  ï¼ˆç›´æ¥å»ºç«‹ï¼‰"
        echo ""
        return 1
    fi

    echo -e "${BOLD}${CYAN}ğŸ“‹ å¯ç”¨çš„ Tmux Sessions:${RESET}"
    echo ""

    # ä½¿ç”¨ tmux æ ¼å¼åŒ–è¼¸å‡º
    tmux list-sessions -F "#{session_name}|#{session_windows}|#{session_attached}" | while IFS='|' read -r name windows attached; do
        if [[ "$attached" == "1" ]]; then
            echo -e "  ${GREEN}â—${RESET} ${BOLD}$name${RESET} (${windows} windows, ${GREEN}attached${RESET})"
        else
            echo -e "  ${YELLOW}â—‹${RESET} $name (${windows} windows)"
        fi
    done

    echo ""
}

get_project_session_name() {
    local current_dir="$PWD"
    local project_name=""

    # æª¢æŸ¥æ˜¯å¦ç‚º git repo
    if git rev-parse --is-inside-work-tree &>/dev/null; then
        # å–å¾— repo root çš„åç¨±
        local repo_root=$(git rev-parse --show-toplevel)
        project_name=$(basename "$repo_root")
    else
        # ä½¿ç”¨ç•¶å‰ç›®éŒ„åç¨±
        project_name=$(basename "$current_dir")
    fi

    # å»ºç«‹ session åç¨±ï¼ˆæ ¼å¼ï¼šai-{project_name}ï¼‰
    echo "ai-${project_name}"
}

check_session_exists() {
    local session_name="$1"
    tmux has-session -t "$session_name" 2>/dev/null
}

attach_to_session() {
    local session_name="$1"

    # æª¢æŸ¥æ˜¯å¦å·²åœ¨ tmux å…§
    if [[ -n "$TMUX" ]]; then
        # åœ¨ tmux å…§ï¼Œä½¿ç”¨ switch-client
        print_success "åˆ‡æ›åˆ° session '$session_name'..."
        tmux switch-client -t "$session_name"
    else
        # ä¸åœ¨ tmux å…§ï¼Œä½¿ç”¨ attach-session
        print_success "é€£æ¥åˆ° session '$session_name'..."
        tmux attach-session -t "$session_name"
    fi
}

create_new_session() {
    local session_name="$1"
    local project_dir="$PWD"

    echo ""
    print_warning "Session '$session_name' ä¸å­˜åœ¨"
    echo ""
    echo "æ˜¯å¦ä½¿ç”¨ AI Workspace å¸ƒå±€å»ºç«‹æ–° sessionï¼Ÿ"
    echo -e "å¸ƒå±€ï¼š${CYAN}å·¦å´ Codex (70%) + å³å´ Claude/Monitor (30%)${RESET}"
    echo ""
    read -p "ç¢ºèªå»ºç«‹ï¼Ÿ [Y/n]: " confirm

    if [[ "$confirm" == "n" || "$confirm" == "N" ]]; then
        echo ""
        print_info "å·²å–æ¶ˆ"
        echo ""
        list_sessions
        return 1
    fi

    echo ""
    print_rocket "æ­£åœ¨å»ºç«‹ AI Workspace..."

    # æª¢æŸ¥ ai-workspace.sh æ˜¯å¦å­˜åœ¨
    local layout_script="$HOME/.tmux-layouts/ai-workspace.sh"

    if [[ ! -f "$layout_script" ]]; then
        print_error "æ‰¾ä¸åˆ°å¸ƒå±€è…³æœ¬ï¼š$layout_script"
        echo ""
        echo "è«‹å…ˆåŸ·è¡Œå®‰è£è…³æœ¬ï¼š"
        echo -e "  ${ORANGE}cd ~/Documents/GitHub/VibeGhostty/tmux${RESET}"
        echo -e "  ${ORANGE}./install.sh${RESET}"
        echo ""
        return 1
    fi

    # åŸ·è¡Œå¸ƒå±€è…³æœ¬ï¼ˆä¸å‚³éåƒæ•¸ï¼Œè®“å®ƒè‡ªå‹•åµæ¸¬ï¼‰
    "$layout_script" "$project_dir"
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Main Logic
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

main() {
    # æª¢æŸ¥ tmux æ˜¯å¦å®‰è£
    if ! command -v tmux &>/dev/null; then
        print_error "Tmux æœªå®‰è£"
        echo ""
        echo "è«‹å…ˆå®‰è£ Tmuxï¼š"
        echo -e "  ${ORANGE}brew install tmux${RESET}  (macOS)"
        echo ""
        return 1
    fi

    # è§£æåƒæ•¸
    case "${1:-}" in
        -h|--help)
            show_help
            return 0
            ;;
        -l|--list)
            list_sessions
            return 0
            ;;
        -n|--name)
            if [[ -z "${2:-}" ]]; then
                print_error "è«‹æŒ‡å®š session åç¨±"
                echo ""
                echo "ç”¨æ³•ï¼šta -n SESSION_NAME"
                echo ""
                list_sessions
                return 1
            fi

            local session_name="$2"

            if check_session_exists "$session_name"; then
                attach_to_session "$session_name"
            else
                print_error "Session '$session_name' ä¸å­˜åœ¨"
                echo ""
                list_sessions
                return 1
            fi
            return 0
            ;;
        "")
            # è‡ªå‹•åµæ¸¬æ¨¡å¼
            local session_name=$(get_project_session_name)

            if check_session_exists "$session_name"; then
                attach_to_session "$session_name"
            else
                create_new_session "$session_name"
            fi
            return 0
            ;;
        *)
            print_error "æœªçŸ¥çš„åƒæ•¸ï¼š$1"
            echo ""
            echo "ä½¿ç”¨ ta -h æŸ¥çœ‹å¹«åŠ©"
            echo ""
            return 1
            ;;
    esac
}

# åŸ·è¡Œä¸»ç¨‹å¼
main "$@"
