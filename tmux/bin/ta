#!/usr/bin/env bash
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Tmux Attach - æ™ºèƒ½ Tmux Session Wrapper
# Created for Frank Yang - VibeGhostty Project
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# å¿«é€Ÿ attach åˆ°ç•¶å‰å°ˆæ¡ˆçš„ tmux session
# åªéœ€è¼¸å…¥ 2 å€‹å­—å…ƒå³å¯ï¼æ”¯æ´ fuzzy matchingï¼
#
# Usage:
#   ta                   è‡ªå‹•åµæ¸¬ç•¶å‰å°ˆæ¡ˆ
#   ta -l                åˆ—å‡ºæ‰€æœ‰ session
#   ta -n NAME           attach åˆ°æŒ‡å®š session (æ”¯æ´æ¨¡ç³ŠåŒ¹é…)
#   ta -s PATTERN        æœå°‹åŒ¹é…çš„ sessions
#   ta -h                é¡¯ç¤ºå¹«åŠ©
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

set -e

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Colors
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

BOLD="\033[1m"
BLUE="\033[38;5;111m"
CYAN="\033[36m"
GREEN="\033[32m"
YELLOW="\033[33m"
RED="\033[31m"
ORANGE="\033[38;5;215m"
RESET="\033[0m"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Helper Functions
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

print_success() {
    echo -e "${GREEN}âœ… $1${RESET}"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${RESET}"
}

print_error() {
    echo -e "${RED}âŒ $1${RESET}"
}

print_info() {
    echo -e "${CYAN}â„¹ï¸  $1${RESET}"
}

print_rocket() {
    echo -e "${BLUE}ğŸš€ $1${RESET}"
}

show_help() {
    cat << 'EOF'
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              ta - æ™ºèƒ½ Tmux Session ç®¡ç†å·¥å…·               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

EOF
    echo -e "${BOLD}${BLUE}ç”¨æ³•ï¼š${RESET}"
    echo ""
    echo "  ta                   è‡ªå‹•åµæ¸¬ç•¶å‰å°ˆæ¡ˆä¸¦ attach"
    echo "  ta -l                åˆ—å‡ºæ‰€æœ‰ tmux session (è©³ç´°è¡¨æ ¼)"
    echo "  ta --list            åŒä¸Š"
    echo "  ta -n NAME           attach åˆ°æŒ‡å®šåç¨±çš„ session (æ”¯æ´æ¨¡ç³ŠåŒ¹é…)"
    echo "  ta --name NAME       åŒä¸Š"
    echo "  ta -s PATTERN        æœå°‹åŒ¹é… pattern çš„ sessions"
    echo "  ta --search PATTERN  åŒä¸Š"
    echo "  ta -h                é¡¯ç¤ºæ­¤å¹«åŠ©"
    echo "  ta --help            åŒä¸Š"
    echo ""
    echo -e "${BOLD}${ORANGE}åŠŸèƒ½ç‰¹è‰²ï¼š${RESET}"
    echo ""
    echo "  ğŸ¯ è‡ªå‹•åµæ¸¬"
    echo "     â€¢ Git repo â†’ session åç¨± = ai-{repo_name}"
    echo "     â€¢ é git â†’ session åç¨± = ai-{directory_name}"
    echo ""
    echo "  ğŸ” æ¨¡ç³ŠåŒ¹é… (Fuzzy Matching)"
    echo "     â€¢ éƒ¨åˆ†åŒ¹é…ï¼š'vibe' å¯åŒ¹é… 'ai-vibeghostty'"
    echo "     â€¢ ä¸å€åˆ†å¤§å°å¯«ï¼š'WORK' å¯åŒ¹é… 'ai-work'"
    echo "     â€¢ å¤šå€‹åŒ¹é… â†’ äº’å‹•å¼é¸å–®è®“ä½ é¸æ“‡"
    echo ""
    echo "  ğŸ“‹ å¢å¼·åˆ—è¡¨é¡¯ç¤º"
    echo "     â€¢ è¡¨æ ¼æ ¼å¼é¡¯ç¤º session è³‡è¨Š"
    echo "     â€¢ é¡¯ç¤ºè¦–çª—æ•¸ã€å‰µå»ºæ™‚é–“ã€attached ç‹€æ…‹"
    echo "     â€¢ ä½¿ç”¨é¡è‰²å’Œ emoji æå‡å¯è®€æ€§"
    echo ""
    echo "  ğŸ”„ Tmux å…§éƒ¨æ”¯æ´"
    echo "     â€¢ å·²åœ¨ tmux å…§ â†’ ä½¿ç”¨ switch-client"
    echo "     â€¢ ä¸åœ¨ tmux å…§ â†’ ä½¿ç”¨ attach-session"
    echo ""
    echo -e "${BOLD}${GREEN}ä½¿ç”¨ç¯„ä¾‹ï¼š${RESET}"
    echo ""
    echo "  # åœ¨å°ˆæ¡ˆç›®éŒ„å¿«é€Ÿ attach"
    echo "  $ cd ~/projects/VibeGhostty"
    echo "  $ ta"
    echo ""
    echo "  # æ¨¡ç³ŠåŒ¹é… session åç¨±"
    echo "  $ ta -n vibe          # åŒ¹é… 'ai-vibeghostty'"
    echo "  $ ta -n work          # åŒ¹é…æ‰€æœ‰åŒ…å« 'work' çš„ sessions"
    echo ""
    echo "  # æœå°‹ç‰¹å®š pattern"
    echo "  $ ta -s ai-           # åˆ—å‡ºæ‰€æœ‰ä»¥ 'ai-' é–‹é ­çš„ sessions"
    echo "  $ ta -s backend       # åˆ—å‡ºæ‰€æœ‰åŒ…å« 'backend' çš„ sessions"
    echo ""
    echo "  # åˆ—å‡ºæ‰€æœ‰ sessionï¼ˆå¢å¼·è¡¨æ ¼æ ¼å¼ï¼‰"
    echo "  $ ta -l"
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
}

list_sessions() {
    if ! tmux list-sessions &>/dev/null; then
        print_warning "ç›®å‰æ²’æœ‰ä»»ä½• tmux session"
        echo ""
        echo "å»ºè­°åŸ·è¡Œä»¥ä¸‹å‘½ä»¤å»ºç«‹ AI Workspaceï¼š"
        echo -e "  ${ORANGE}tmux-launch${RESET}  ï¼ˆäº’å‹•å¼é¸å–®ï¼‰"
        echo -e "  ${ORANGE}~/.tmux-layouts/ai-workspace.sh${RESET}  ï¼ˆç›´æ¥å»ºç«‹ï¼‰"
        echo ""
        return 1
    fi

    echo -e "${BOLD}${CYAN}ğŸ“‹ å¯ç”¨çš„ Tmux Sessions${RESET}"
    echo ""

    # è¡¨æ ¼æ¨™é¡Œ
    printf "  ${BOLD}%-3s %-30s %-8s %-20s %-10s${RESET}\n" "#" "Session Name" "Windows" "Created" "Status"
    echo "  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

    # è®€å–æ‰€æœ‰ sessions ä¸¦æ’åº
    local index=1
    tmux list-sessions -F "#{session_name}|#{session_windows}|#{session_created}|#{session_attached}" | sort | while IFS='|' read -r name windows created attached; do
        # æ ¼å¼åŒ–å‰µå»ºæ™‚é–“
        local created_time=$(date -r "$created" "+%Y-%m-%d %H:%M" 2>/dev/null || echo "Unknown")

        # æ ¹æ“š attached ç‹€æ…‹è¨­å®šé¡¯ç¤º
        if [[ "$attached" == "1" ]]; then
            local status="${GREEN}âœ“ Attached${RESET}"
            local name_display="${BOLD}${GREEN}$name${RESET}"
            local icon="${GREEN}â—${RESET}"
        else
            local status="${YELLOW}â—‹ Detached${RESET}"
            local name_display="$name"
            local icon="${YELLOW}â—‹${RESET}"
        fi

        # è¼¸å‡ºè¡¨æ ¼è¡Œ
        printf "  ${icon} %-2s %-30s %-8s %-20s %b\n" "$index" "$name_display" "$windows" "$created_time" "$status"
        index=$((index + 1))
    done

    echo ""
}

# æœå°‹ sessionsï¼ˆæ”¯æ´æ­£å‰‡è¡¨é”å¼ï¼‰
search_sessions() {
    local pattern="$1"

    if ! tmux list-sessions &>/dev/null; then
        print_warning "ç›®å‰æ²’æœ‰ä»»ä½• tmux session"
        return 1
    fi

    echo -e "${BOLD}${CYAN}ğŸ” æœå°‹çµæœ (pattern: '$pattern')${RESET}"
    echo ""

    # ä½¿ç”¨ grep é€²è¡Œä¸å€åˆ†å¤§å°å¯«æœå°‹
    local matches=$(tmux list-sessions -F "#{session_name}" | grep -i "$pattern" || true)

    if [[ -z "$matches" ]]; then
        print_warning "æ²’æœ‰æ‰¾åˆ°åŒ¹é… '$pattern' çš„ session"
        echo ""
        echo "å»ºè­°ï¼š"
        echo "  â€¢ ä½¿ç”¨ ${ORANGE}ta -l${RESET} æŸ¥çœ‹æ‰€æœ‰ sessions"
        echo "  â€¢ ç¢ºèªæ‹¼å¯«æ˜¯å¦æ­£ç¢º"
        echo ""
        return 1
    fi

    # é¡¯ç¤ºåŒ¹é…çš„ sessionsï¼ˆä½¿ç”¨è¡¨æ ¼æ ¼å¼ï¼‰
    printf "  ${BOLD}%-3s %-30s %-8s %-10s${RESET}\n" "#" "Session Name" "Windows" "Status"
    echo "  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

    local index=1
    echo "$matches" | while read -r name; do
        local session_info=$(tmux list-sessions -F "#{session_name}|#{session_windows}|#{session_attached}" | grep "^${name}|")
        IFS='|' read -r _ windows attached <<< "$session_info"

        if [[ "$attached" == "1" ]]; then
            local status="${GREEN}âœ“ Attached${RESET}"
            local icon="${GREEN}â—${RESET}"
        else
            local status="${YELLOW}â—‹ Detached${RESET}"
            local icon="${YELLOW}â—‹${RESET}"
        fi

        printf "  ${icon} %-2s %-30s %-8s %b\n" "$index" "$name" "$windows" "$status"
        index=$((index + 1))
    done

    echo ""
    echo "æ‰¾åˆ° $(echo "$matches" | wc -l | tr -d ' ') å€‹åŒ¹é…çš„ sessions"
    echo ""
}

get_project_session_name() {
    local current_dir="$PWD"
    local project_name=""

    # æª¢æŸ¥æ˜¯å¦ç‚º git repo
    if git rev-parse --is-inside-work-tree &>/dev/null; then
        # å–å¾— repo root çš„åç¨±
        local repo_root=$(git rev-parse --show-toplevel)
        project_name=$(basename "$repo_root")
    else
        # ä½¿ç”¨ç•¶å‰ç›®éŒ„åç¨±
        project_name=$(basename "$current_dir")
    fi

    # å»ºç«‹ session åç¨±ï¼ˆæ ¼å¼ï¼šai-{project_name}ï¼‰
    echo "ai-${project_name}"
}

check_session_exists() {
    local session_name="$1"
    tmux has-session -t "$session_name" 2>/dev/null
}

# Fuzzy matching - å°‹æ‰¾åŒ¹é…çš„ sessions
find_matching_sessions() {
    local pattern="$1"

    if ! tmux list-sessions &>/dev/null; then
        return 1
    fi

    # å…ˆå˜—è©¦ç²¾ç¢ºåŒ¹é…
    if tmux has-session -t "$pattern" 2>/dev/null; then
        echo "$pattern"
        return 0
    fi

    # ä½¿ç”¨ grep é€²è¡Œä¸å€åˆ†å¤§å°å¯«çš„æ¨¡ç³ŠåŒ¹é…
    local matches=$(tmux list-sessions -F "#{session_name}" | grep -i "$pattern" || true)

    if [[ -n "$matches" ]]; then
        echo "$matches"
        return 0
    fi

    return 1
}

# äº’å‹•å¼é¸æ“‡ session
select_session_interactive() {
    local matches="$1"
    local pattern="$2"

    local match_count=$(echo "$matches" | wc -l | tr -d ' ')

    # åªæœ‰ä¸€å€‹åŒ¹é…ï¼Œç›´æ¥è¿”å›
    if [[ "$match_count" -eq 1 ]]; then
        echo "$matches"
        return 0
    fi

    # å¤šå€‹åŒ¹é…ï¼Œé¡¯ç¤ºé¸å–®
    echo ""
    echo -e "${BOLD}${CYAN}ğŸ” æ‰¾åˆ° $match_count å€‹åŒ¹é… '$pattern' çš„ sessions${RESET}"
    echo ""

    # é¡¯ç¤ºé¸å–®
    printf "  ${BOLD}%-3s %-30s %-8s %-10s${RESET}\n" "#" "Session Name" "Windows" "Status"
    echo "  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

    local index=1
    local -a session_array=()

    while IFS= read -r name; do
        session_array+=("$name")
        local session_info=$(tmux list-sessions -F "#{session_name}|#{session_windows}|#{session_attached}" | grep "^${name}|")
        IFS='|' read -r _ windows attached <<< "$session_info"

        if [[ "$attached" == "1" ]]; then
            local status="${GREEN}âœ“ Attached${RESET}"
            local icon="${GREEN}â—${RESET}"
        else
            local status="${YELLOW}â—‹ Detached${RESET}"
            local icon="${YELLOW}â—‹${RESET}"
        fi

        printf "  ${icon} %-2s %-30s %-8s %b\n" "$index" "$name" "$windows" "$status"
        index=$((index + 1))
    done <<< "$matches"

    echo ""
    echo -e "${BOLD}é¸æ“‡è¦ attach çš„ session (è¼¸å…¥ç·¨è™Ÿæˆ–æŒ‰ Ctrl+C å–æ¶ˆ):${RESET}"
    read -p "> " choice

    # é©—è­‰è¼¸å…¥
    if [[ ! "$choice" =~ ^[0-9]+$ ]] || [[ "$choice" -lt 1 ]] || [[ "$choice" -gt "$match_count" ]]; then
        echo ""
        print_error "ç„¡æ•ˆçš„é¸æ“‡: $choice"
        return 1
    fi

    # è¿”å›é¸ä¸­çš„ session
    echo "${session_array[$((choice - 1))]}"
    return 0
}

attach_to_session() {
    local session_name="$1"

    # æª¢æŸ¥æ˜¯å¦å·²åœ¨ tmux å…§
    if [[ -n "$TMUX" ]]; then
        # åœ¨ tmux å…§ï¼Œä½¿ç”¨ switch-client
        print_success "åˆ‡æ›åˆ° session '$session_name'..."
        tmux switch-client -t "$session_name"
    else
        # ä¸åœ¨ tmux å…§ï¼Œä½¿ç”¨ attach-session
        print_success "é€£æ¥åˆ° session '$session_name'..."
        tmux attach-session -t "$session_name"
    fi
}

create_new_session() {
    local session_name="$1"
    local project_dir="$PWD"

    echo ""
    print_warning "Session '$session_name' ä¸å­˜åœ¨"
    echo ""
    echo "æ˜¯å¦ä½¿ç”¨ AI Workspace å¸ƒå±€å»ºç«‹æ–° sessionï¼Ÿ"
    echo -e "å¸ƒå±€ï¼š${CYAN}å·¦å´ Codex (70%) + å³å´ Claude/Monitor (30%)${RESET}"
    echo ""
    read -p "ç¢ºèªå»ºç«‹ï¼Ÿ [Y/n]: " confirm

    if [[ "$confirm" == "n" || "$confirm" == "N" ]]; then
        echo ""
        print_info "å·²å–æ¶ˆ"
        echo ""
        list_sessions
        return 1
    fi

    echo ""
    print_rocket "æ­£åœ¨å»ºç«‹ AI Workspace..."

    # æª¢æŸ¥ ai-workspace.sh æ˜¯å¦å­˜åœ¨
    local layout_script="$HOME/.tmux-layouts/ai-workspace.sh"

    if [[ ! -f "$layout_script" ]]; then
        print_error "æ‰¾ä¸åˆ°å¸ƒå±€è…³æœ¬ï¼š$layout_script"
        echo ""
        echo "è«‹å…ˆåŸ·è¡Œå®‰è£è…³æœ¬ï¼š"
        echo -e "  ${ORANGE}cd ~/Documents/GitHub/VibeGhostty/tmux${RESET}"
        echo -e "  ${ORANGE}./install.sh${RESET}"
        echo ""
        return 1
    fi

    # åŸ·è¡Œå¸ƒå±€è…³æœ¬ï¼ˆä¸å‚³éåƒæ•¸ï¼Œè®“å®ƒè‡ªå‹•åµæ¸¬ï¼‰
    "$layout_script" "$project_dir"
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Main Logic
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

main() {
    # æª¢æŸ¥ tmux æ˜¯å¦å®‰è£
    if ! command -v tmux &>/dev/null; then
        print_error "Tmux æœªå®‰è£"
        echo ""
        echo "è«‹å…ˆå®‰è£ Tmuxï¼š"
        echo -e "  ${ORANGE}brew install tmux${RESET}  (macOS)"
        echo ""
        return 1
    fi

    # è§£æåƒæ•¸
    case "${1:-}" in
        -h|--help)
            show_help
            return 0
            ;;
        -l|--list)
            list_sessions
            return 0
            ;;
        -s|--search)
            if [[ -z "${2:-}" ]]; then
                print_error "è«‹æŒ‡å®šæœå°‹ pattern"
                echo ""
                echo "ç”¨æ³•ï¼šta -s PATTERN"
                echo "ç¯„ä¾‹ï¼šta -s ai-    (æœå°‹æ‰€æœ‰ä»¥ 'ai-' é–‹é ­çš„ sessions)"
                echo ""
                return 1
            fi

            search_sessions "$2"
            return 0
            ;;
        -n|--name)
            if [[ -z "${2:-}" ]]; then
                print_error "è«‹æŒ‡å®š session åç¨±"
                echo ""
                echo "ç”¨æ³•ï¼šta -n SESSION_NAME"
                echo ""
                list_sessions
                return 1
            fi

            local input_name="$2"

            # å…ˆå˜—è©¦ç²¾ç¢ºåŒ¹é…
            if check_session_exists "$input_name"; then
                attach_to_session "$input_name"
                return 0
            fi

            # ç²¾ç¢ºåŒ¹é…å¤±æ•—ï¼Œå˜—è©¦æ¨¡ç³ŠåŒ¹é…
            print_info "Session '$input_name' ä¸å­˜åœ¨ï¼Œå˜—è©¦æ¨¡ç³ŠåŒ¹é…..."
            echo ""

            local matches=$(find_matching_sessions "$input_name")
            local match_result=$?

            if [[ $match_result -ne 0 ]] || [[ -z "$matches" ]]; then
                print_error "æ²’æœ‰æ‰¾åˆ°åŒ¹é… '$input_name' çš„ session"
                echo ""
                echo "å»ºè­°ï¼š"
                echo "  â€¢ ä½¿ç”¨ ${ORANGE}ta -l${RESET} æŸ¥çœ‹æ‰€æœ‰å¯ç”¨çš„ sessions"
                echo "  â€¢ ä½¿ç”¨ ${ORANGE}ta -s '$input_name'${RESET} æœå°‹ç›¸é—œçš„ sessions"
                echo "  â€¢ ç¢ºèªæ‹¼å¯«æ˜¯å¦æ­£ç¢ºï¼ˆæ”¯æ´ä¸å€åˆ†å¤§å°å¯«ï¼‰"
                echo ""
                echo "ç¯„ä¾‹ï¼š"
                echo "  ta -n vibe          # æœƒåŒ¹é… 'ai-vibeghostty'"
                echo "  ta -n work          # æœƒåŒ¹é…æ‰€æœ‰åŒ…å« 'work' çš„ sessions"
                echo ""
                list_sessions
                return 1
            fi

            # æœ‰åŒ¹é…ï¼Œä½¿ç”¨äº’å‹•å¼é¸æ“‡
            local selected_session=$(select_session_interactive "$matches" "$input_name")
            local select_result=$?

            if [[ $select_result -ne 0 ]] || [[ -z "$selected_session" ]]; then
                echo ""
                print_info "å·²å–æ¶ˆ"
                return 1
            fi

            echo ""
            print_success "æ¨¡ç³ŠåŒ¹é…æˆåŠŸï¼š'$input_name' â†’ '$selected_session'"
            attach_to_session "$selected_session"
            return 0
            ;;
        "")
            # è‡ªå‹•åµæ¸¬æ¨¡å¼
            local session_name=$(get_project_session_name)

            if check_session_exists "$session_name"; then
                attach_to_session "$session_name"
            else
                create_new_session "$session_name"
            fi
            return 0
            ;;
        *)
            print_error "æœªçŸ¥çš„åƒæ•¸ï¼š$1"
            echo ""
            echo "ä½¿ç”¨ ta -h æŸ¥çœ‹å¹«åŠ©"
            echo ""
            return 1
            ;;
    esac
}

# åŸ·è¡Œä¸»ç¨‹å¼
main "$@"
